{
  "slug": "mosaic-augmentation",
  "name": "Mosaic Augmentation",
  "categories": [
    "computervision"
  ],
  "body": {},
  "implementations": {
    "python": {
      "dir": "computer_vision\\mosaic_augmentation.py",
      "url": "https://github.com/TheAlgorithms/python/tree/master/computer_vision\\mosaic_augmentation.py",
      "code": "<span class=\"hljs-string\">&quot;&quot;&quot;Source: https://github.com/jason9075/opencv-mosaic-data-aug&quot;&quot;&quot;</span>\r\n\r\n<span class=\"hljs-keyword\">import</span> glob\r\n<span class=\"hljs-keyword\">import</span> os\r\n<span class=\"hljs-keyword\">import</span> random\r\n<span class=\"hljs-keyword\">from</span> string <span class=\"hljs-keyword\">import</span> ascii_lowercase, digits\r\n\r\n<span class=\"hljs-keyword\">import</span> cv2\r\n<span class=\"hljs-keyword\">import</span> numpy <span class=\"hljs-keyword\">as</span> np\r\n\r\n<span class=\"hljs-comment\"># Parrameters</span>\r\nOUTPUT_SIZE = (<span class=\"hljs-number\">720</span>, <span class=\"hljs-number\">1280</span>)  <span class=\"hljs-comment\"># Height, Width</span>\r\nSCALE_RANGE = (<span class=\"hljs-number\">0.4</span>, <span class=\"hljs-number\">0.6</span>)  <span class=\"hljs-comment\"># if height or width lower than this scale, drop it.</span>\r\nFILTER_TINY_SCALE = <span class=\"hljs-number\">1</span> / <span class=\"hljs-number\">100</span>\r\nLABEL_DIR = <span class=\"hljs-string\">&quot;&quot;</span>\r\nIMG_DIR = <span class=\"hljs-string\">&quot;&quot;</span>\r\nOUTPUT_DIR = <span class=\"hljs-string\">&quot;&quot;</span>\r\nNUMBER_IMAGES = <span class=\"hljs-number\">250</span>\r\n\r\n\r\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">main</span>() -&gt; <span class=\"hljs-literal\">None</span>:\r\n    <span class=\"hljs-string\">&quot;&quot;&quot;\r\n    Get images list and annotations list from input dir.\r\n    Update new images and annotations.\r\n    Save images and annotations in output dir.\r\n    &gt;&gt;&gt; pass  # A doctest is not possible for this function.\r\n    &quot;&quot;&quot;</span>\r\n    img_paths, annos = get_dataset(LABEL_DIR, IMG_DIR)\r\n    <span class=\"hljs-keyword\">for</span> index <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(NUMBER_IMAGES):\r\n        idxs = random.sample(<span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(annos)), <span class=\"hljs-number\">4</span>)\r\n        new_image, new_annos, path = update_image_and_anno(\r\n            img_paths,\r\n            annos,\r\n            idxs,\r\n            OUTPUT_SIZE,\r\n            SCALE_RANGE,\r\n            filter_scale=FILTER_TINY_SCALE,\r\n        )\r\n\r\n        <span class=\"hljs-comment\"># Get random string code: &#x27;7b7ad245cdff75241935e4dd860f3bad&#x27;</span>\r\n        letter_code = random_chars(<span class=\"hljs-number\">32</span>)\r\n        file_name = path.split(os.sep)[-<span class=\"hljs-number\">1</span>].rsplit(<span class=\"hljs-string\">&quot;.&quot;</span>, <span class=\"hljs-number\">1</span>)[<span class=\"hljs-number\">0</span>]\r\n        file_root = <span class=\"hljs-string\">f&quot;<span class=\"hljs-subst\">{OUTPUT_DIR}</span>/<span class=\"hljs-subst\">{file_name}</span>_MOSAIC_<span class=\"hljs-subst\">{letter_code}</span>&quot;</span>\r\n        cv2.imwrite(<span class=\"hljs-string\">f&quot;<span class=\"hljs-subst\">{file_root}</span>.jpg&quot;</span>, new_image, [cv2.IMWRITE_JPEG_QUALITY, <span class=\"hljs-number\">85</span>])\r\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f&quot;Succeeded <span class=\"hljs-subst\">{index+<span class=\"hljs-number\">1</span>}</span>/<span class=\"hljs-subst\">{NUMBER_IMAGES}</span> with <span class=\"hljs-subst\">{file_name}</span>&quot;</span>)\r\n        annos_list = []\r\n        <span class=\"hljs-keyword\">for</span> anno <span class=\"hljs-keyword\">in</span> new_annos:\r\n            width = anno[<span class=\"hljs-number\">3</span>] - anno[<span class=\"hljs-number\">1</span>]\r\n            height = anno[<span class=\"hljs-number\">4</span>] - anno[<span class=\"hljs-number\">2</span>]\r\n            x_center = anno[<span class=\"hljs-number\">1</span>] + width / <span class=\"hljs-number\">2</span>\r\n            y_center = anno[<span class=\"hljs-number\">2</span>] + height / <span class=\"hljs-number\">2</span>\r\n            obj = <span class=\"hljs-string\">f&quot;<span class=\"hljs-subst\">{anno[<span class=\"hljs-number\">0</span>]}</span> <span class=\"hljs-subst\">{x_center}</span> <span class=\"hljs-subst\">{y_center}</span> <span class=\"hljs-subst\">{width}</span> <span class=\"hljs-subst\">{height}</span>&quot;</span>\r\n            annos_list.append(obj)\r\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(<span class=\"hljs-string\">f&quot;<span class=\"hljs-subst\">{file_root}</span>.txt&quot;</span>, <span class=\"hljs-string\">&quot;w&quot;</span>) <span class=\"hljs-keyword\">as</span> outfile:\r\n            outfile.write(<span class=\"hljs-string\">&quot;\\n&quot;</span>.join(line <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> annos_list))\r\n\r\n\r\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_dataset</span>(<span class=\"hljs-params\">label_dir: <span class=\"hljs-built_in\">str</span>, img_dir: <span class=\"hljs-built_in\">str</span></span>) -&gt; <span class=\"hljs-built_in\">tuple</span>[<span class=\"hljs-built_in\">list</span>, <span class=\"hljs-built_in\">list</span>]:\r\n    <span class=\"hljs-string\">&quot;&quot;&quot;\r\n    - label_dir &lt;type: str&gt;: Path to label include annotation of images\r\n    - img_dir &lt;type: str&gt;: Path to folder contain images\r\n    Return &lt;type: list&gt;: List of images path and labels\r\n    &gt;&gt;&gt; pass  # A doctest is not possible for this function.\r\n    &quot;&quot;&quot;</span>\r\n    img_paths = []\r\n    labels = []\r\n    <span class=\"hljs-keyword\">for</span> label_file <span class=\"hljs-keyword\">in</span> glob.glob(os.path.join(label_dir, <span class=\"hljs-string\">&quot;*.txt&quot;</span>)):\r\n        label_name = label_file.split(os.sep)[-<span class=\"hljs-number\">1</span>].rsplit(<span class=\"hljs-string\">&quot;.&quot;</span>, <span class=\"hljs-number\">1</span>)[<span class=\"hljs-number\">0</span>]\r\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(label_file) <span class=\"hljs-keyword\">as</span> in_file:\r\n            obj_lists = in_file.readlines()\r\n        img_path = os.path.join(img_dir, <span class=\"hljs-string\">f&quot;<span class=\"hljs-subst\">{label_name}</span>.jpg&quot;</span>)\r\n\r\n        boxes = []\r\n        <span class=\"hljs-keyword\">for</span> obj_list <span class=\"hljs-keyword\">in</span> obj_lists:\r\n            obj = obj_list.rstrip(<span class=\"hljs-string\">&quot;\\n&quot;</span>).split(<span class=\"hljs-string\">&quot; &quot;</span>)\r\n            xmin = <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">1</span>]) - <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">3</span>]) / <span class=\"hljs-number\">2</span>\r\n            ymin = <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">2</span>]) - <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">4</span>]) / <span class=\"hljs-number\">2</span>\r\n            xmax = <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">1</span>]) + <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">3</span>]) / <span class=\"hljs-number\">2</span>\r\n            ymax = <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">2</span>]) + <span class=\"hljs-built_in\">float</span>(obj[<span class=\"hljs-number\">4</span>]) / <span class=\"hljs-number\">2</span>\r\n\r\n            boxes.append([<span class=\"hljs-built_in\">int</span>(obj[<span class=\"hljs-number\">0</span>]), xmin, ymin, xmax, ymax])\r\n        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> boxes:\r\n            <span class=\"hljs-keyword\">continue</span>\r\n        img_paths.append(img_path)\r\n        labels.append(boxes)\r\n    <span class=\"hljs-keyword\">return</span> img_paths, labels\r\n\r\n\r\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">update_image_and_anno</span>(<span class=\"hljs-params\">\r\n    all_img_list: <span class=\"hljs-built_in\">list</span>,\r\n    all_annos: <span class=\"hljs-built_in\">list</span>,\r\n    idxs: <span class=\"hljs-built_in\">list</span>[<span class=\"hljs-built_in\">int</span>],\r\n    output_size: <span class=\"hljs-built_in\">tuple</span>[<span class=\"hljs-built_in\">int</span>, <span class=\"hljs-built_in\">int</span>],\r\n    scale_range: <span class=\"hljs-built_in\">tuple</span>[<span class=\"hljs-built_in\">float</span>, <span class=\"hljs-built_in\">float</span>],\r\n    filter_scale: <span class=\"hljs-built_in\">float</span> = <span class=\"hljs-number\">0.0</span>,\r\n</span>) -&gt; <span class=\"hljs-built_in\">tuple</span>[<span class=\"hljs-built_in\">list</span>, <span class=\"hljs-built_in\">list</span>, <span class=\"hljs-built_in\">str</span>]:\r\n    <span class=\"hljs-string\">&quot;&quot;&quot;\r\n    - all_img_list &lt;type: list&gt;: list of all images\r\n    - all_annos &lt;type: list&gt;: list of all annotations of specific image\r\n    - idxs &lt;type: list&gt;: index of image in list\r\n    - output_size &lt;type: tuple&gt;: size of output image (Height, Width)\r\n    - scale_range &lt;type: tuple&gt;: range of scale image\r\n    - filter_scale &lt;type: float&gt;: the condition of downscale image and bounding box\r\n    Return:\r\n        - output_img &lt;type: narray&gt;: image after resize\r\n        - new_anno &lt;type: list&gt;: list of new annotation after scale\r\n        - path[0] &lt;type: string&gt;: get the name of image file\r\n    &gt;&gt;&gt; pass  # A doctest is not possible for this function.\r\n    &quot;&quot;&quot;</span>\r\n    output_img = np.zeros([output_size[<span class=\"hljs-number\">0</span>], output_size[<span class=\"hljs-number\">1</span>], <span class=\"hljs-number\">3</span>], dtype=np.uint8)\r\n    scale_x = scale_range[<span class=\"hljs-number\">0</span>] + random.random() * (scale_range[<span class=\"hljs-number\">1</span>] - scale_range[<span class=\"hljs-number\">0</span>])\r\n    scale_y = scale_range[<span class=\"hljs-number\">0</span>] + random.random() * (scale_range[<span class=\"hljs-number\">1</span>] - scale_range[<span class=\"hljs-number\">0</span>])\r\n    divid_point_x = <span class=\"hljs-built_in\">int</span>(scale_x * output_size[<span class=\"hljs-number\">1</span>])\r\n    divid_point_y = <span class=\"hljs-built_in\">int</span>(scale_y * output_size[<span class=\"hljs-number\">0</span>])\r\n\r\n    new_anno = []\r\n    path_list = []\r\n    <span class=\"hljs-keyword\">for</span> i, index <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(idxs):\r\n        path = all_img_list[index]\r\n        path_list.append(path)\r\n        img_annos = all_annos[index]\r\n        img = cv2.imread(path)\r\n        <span class=\"hljs-keyword\">if</span> i == <span class=\"hljs-number\">0</span>:  <span class=\"hljs-comment\"># top-left</span>\r\n            img = cv2.resize(img, (divid_point_x, divid_point_y))\r\n            output_img[:divid_point_y, :divid_point_x, :] = img\r\n            <span class=\"hljs-keyword\">for</span> bbox <span class=\"hljs-keyword\">in</span> img_annos:\r\n                xmin = bbox[<span class=\"hljs-number\">1</span>] * scale_x\r\n                ymin = bbox[<span class=\"hljs-number\">2</span>] * scale_y\r\n                xmax = bbox[<span class=\"hljs-number\">3</span>] * scale_x\r\n                ymax = bbox[<span class=\"hljs-number\">4</span>] * scale_y\r\n                new_anno.append([bbox[<span class=\"hljs-number\">0</span>], xmin, ymin, xmax, ymax])\r\n        <span class=\"hljs-keyword\">elif</span> i == <span class=\"hljs-number\">1</span>:  <span class=\"hljs-comment\"># top-right</span>\r\n            img = cv2.resize(img, (output_size[<span class=\"hljs-number\">1</span>] - divid_point_x, divid_point_y))\r\n            output_img[:divid_point_y, divid_point_x : output_size[<span class=\"hljs-number\">1</span>], :] = img\r\n            <span class=\"hljs-keyword\">for</span> bbox <span class=\"hljs-keyword\">in</span> img_annos:\r\n                xmin = scale_x + bbox[<span class=\"hljs-number\">1</span>] * (<span class=\"hljs-number\">1</span> - scale_x)\r\n                ymin = bbox[<span class=\"hljs-number\">2</span>] * scale_y\r\n                xmax = scale_x + bbox[<span class=\"hljs-number\">3</span>] * (<span class=\"hljs-number\">1</span> - scale_x)\r\n                ymax = bbox[<span class=\"hljs-number\">4</span>] * scale_y\r\n                new_anno.append([bbox[<span class=\"hljs-number\">0</span>], xmin, ymin, xmax, ymax])\r\n        <span class=\"hljs-keyword\">elif</span> i == <span class=\"hljs-number\">2</span>:  <span class=\"hljs-comment\"># bottom-left</span>\r\n            img = cv2.resize(img, (divid_point_x, output_size[<span class=\"hljs-number\">0</span>] - divid_point_y))\r\n            output_img[divid_point_y : output_size[<span class=\"hljs-number\">0</span>], :divid_point_x, :] = img\r\n            <span class=\"hljs-keyword\">for</span> bbox <span class=\"hljs-keyword\">in</span> img_annos:\r\n                xmin = bbox[<span class=\"hljs-number\">1</span>] * scale_x\r\n                ymin = scale_y + bbox[<span class=\"hljs-number\">2</span>] * (<span class=\"hljs-number\">1</span> - scale_y)\r\n                xmax = bbox[<span class=\"hljs-number\">3</span>] * scale_x\r\n                ymax = scale_y + bbox[<span class=\"hljs-number\">4</span>] * (<span class=\"hljs-number\">1</span> - scale_y)\r\n                new_anno.append([bbox[<span class=\"hljs-number\">0</span>], xmin, ymin, xmax, ymax])\r\n        <span class=\"hljs-keyword\">else</span>:  <span class=\"hljs-comment\"># bottom-right</span>\r\n            img = cv2.resize(\r\n                img, (output_size[<span class=\"hljs-number\">1</span>] - divid_point_x, output_size[<span class=\"hljs-number\">0</span>] - divid_point_y)\r\n            )\r\n            output_img[\r\n                divid_point_y : output_size[<span class=\"hljs-number\">0</span>], divid_point_x : output_size[<span class=\"hljs-number\">1</span>], :\r\n            ] = img\r\n            <span class=\"hljs-keyword\">for</span> bbox <span class=\"hljs-keyword\">in</span> img_annos:\r\n                xmin = scale_x + bbox[<span class=\"hljs-number\">1</span>] * (<span class=\"hljs-number\">1</span> - scale_x)\r\n                ymin = scale_y + bbox[<span class=\"hljs-number\">2</span>] * (<span class=\"hljs-number\">1</span> - scale_y)\r\n                xmax = scale_x + bbox[<span class=\"hljs-number\">3</span>] * (<span class=\"hljs-number\">1</span> - scale_x)\r\n                ymax = scale_y + bbox[<span class=\"hljs-number\">4</span>] * (<span class=\"hljs-number\">1</span> - scale_y)\r\n                new_anno.append([bbox[<span class=\"hljs-number\">0</span>], xmin, ymin, xmax, ymax])\r\n\r\n    <span class=\"hljs-comment\"># Remove bounding box small than scale of filter</span>\r\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-number\">0</span> &lt; filter_scale:\r\n        new_anno = [\r\n            anno\r\n            <span class=\"hljs-keyword\">for</span> anno <span class=\"hljs-keyword\">in</span> new_anno\r\n            <span class=\"hljs-keyword\">if</span> filter_scale &lt; (anno[<span class=\"hljs-number\">3</span>] - anno[<span class=\"hljs-number\">1</span>]) <span class=\"hljs-keyword\">and</span> filter_scale &lt; (anno[<span class=\"hljs-number\">4</span>] - anno[<span class=\"hljs-number\">2</span>])\r\n        ]\r\n\r\n    <span class=\"hljs-keyword\">return</span> output_img, new_anno, path_list[<span class=\"hljs-number\">0</span>]\r\n\r\n\r\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_chars</span>(<span class=\"hljs-params\">number_char: <span class=\"hljs-built_in\">int</span></span>) -&gt; <span class=\"hljs-built_in\">str</span>:\r\n    <span class=\"hljs-string\">&quot;&quot;&quot;\r\n    Automatic generate random 32 characters.\r\n    Get random string code: &#x27;7b7ad245cdff75241935e4dd860f3bad&#x27;\r\n    &gt;&gt;&gt; len(random_chars(32))\r\n    32\r\n    &quot;&quot;&quot;</span>\r\n    <span class=\"hljs-keyword\">assert</span> number_char &gt; <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;The number of character should greater than 1&quot;</span>\r\n    letter_code = ascii_lowercase + digits\r\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;&quot;</span>.join(random.choice(letter_code) <span class=\"hljs-keyword\">for</span> _ <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(number_char))\r\n\r\n\r\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&quot;__main__&quot;</span>:\r\n    main()\r\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;DONE ✅&quot;</span>)\r\n"
    }
  },
  "contributors": [
    {
      "name": "Khoi Vo",
      "email": "nguyenkhoi8071@gmail.com",
      "commits": 1
    }
  ],
  "explanationUrl": {}
}