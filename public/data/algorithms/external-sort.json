{
  "slug": "external-sort",
  "name": "External Sort",
  "categories": [
    "sorts"
  ],
  "body": {},
  "implementations": {
    "python": {
      "dir": "sorts\\external_sort.py",
      "url": "https://github.com/TheAlgorithms/python/tree/master/sorts\\external_sort.py",
      "code": "<span class=\"hljs-comment\">#!/usr/bin/env python</span>\r\n\r\n<span class=\"hljs-comment\">#</span>\r\n<span class=\"hljs-comment\"># Sort large text files in a minimum amount of memory</span>\r\n<span class=\"hljs-comment\">#</span>\r\n<span class=\"hljs-keyword\">import</span> argparse\r\n<span class=\"hljs-keyword\">import</span> os\r\n\r\n\r\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FileSplitter</span>:\r\n    BLOCK_FILENAME_FORMAT = <span class=\"hljs-string\">&quot;block_{0}.dat&quot;</span>\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, filename</span>):\r\n        self.filename = filename\r\n        self.block_filenames = []\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">write_block</span>(<span class=\"hljs-params\">self, data, block_number</span>):\r\n        filename = self.BLOCK_FILENAME_FORMAT.<span class=\"hljs-built_in\">format</span>(block_number)\r\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(filename, <span class=\"hljs-string\">&quot;w&quot;</span>) <span class=\"hljs-keyword\">as</span> file:\r\n            file.write(data)\r\n        self.block_filenames.append(filename)\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_block_filenames</span>(<span class=\"hljs-params\">self</span>):\r\n        <span class=\"hljs-keyword\">return</span> self.block_filenames\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">split</span>(<span class=\"hljs-params\">self, block_size, sort_key=<span class=\"hljs-literal\">None</span></span>):\r\n        i = <span class=\"hljs-number\">0</span>\r\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(self.filename) <span class=\"hljs-keyword\">as</span> file:\r\n            <span class=\"hljs-keyword\">while</span> <span class=\"hljs-literal\">True</span>:\r\n                lines = file.readlines(block_size)\r\n\r\n                <span class=\"hljs-keyword\">if</span> lines == []:\r\n                    <span class=\"hljs-keyword\">break</span>\r\n\r\n                <span class=\"hljs-keyword\">if</span> sort_key <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span>:\r\n                    lines.sort()\r\n                <span class=\"hljs-keyword\">else</span>:\r\n                    lines.sort(key=sort_key)\r\n\r\n                self.write_block(<span class=\"hljs-string\">&quot;&quot;</span>.join(lines), i)\r\n                i += <span class=\"hljs-number\">1</span>\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">cleanup</span>(<span class=\"hljs-params\">self</span>):\r\n        <span class=\"hljs-built_in\">map</span>(<span class=\"hljs-keyword\">lambda</span> f: os.remove(f), self.block_filenames)\r\n\r\n\r\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">NWayMerge</span>:\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">select</span>(<span class=\"hljs-params\">self, choices</span>):\r\n        min_index = -<span class=\"hljs-number\">1</span>\r\n        min_str = <span class=\"hljs-literal\">None</span>\r\n\r\n        <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(choices)):\r\n            <span class=\"hljs-keyword\">if</span> min_str <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span> <span class=\"hljs-keyword\">or</span> choices[i] &lt; min_str:\r\n                min_index = i\r\n\r\n        <span class=\"hljs-keyword\">return</span> min_index\r\n\r\n\r\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FilesArray</span>:\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, files</span>):\r\n        self.files = files\r\n        self.empty = <span class=\"hljs-built_in\">set</span>()\r\n        self.num_buffers = <span class=\"hljs-built_in\">len</span>(files)\r\n        self.buffers = {i: <span class=\"hljs-literal\">None</span> <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.num_buffers)}\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_dict</span>(<span class=\"hljs-params\">self</span>):\r\n        <span class=\"hljs-keyword\">return</span> {\r\n            i: self.buffers[i] <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.num_buffers) <span class=\"hljs-keyword\">if</span> i <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">in</span> self.empty\r\n        }\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">refresh</span>(<span class=\"hljs-params\">self</span>):\r\n        <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.num_buffers):\r\n            <span class=\"hljs-keyword\">if</span> self.buffers[i] <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span> <span class=\"hljs-keyword\">and</span> i <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">in</span> self.empty:\r\n                self.buffers[i] = self.files[i].readline()\r\n\r\n                <span class=\"hljs-keyword\">if</span> self.buffers[i] == <span class=\"hljs-string\">&quot;&quot;</span>:\r\n                    self.empty.add(i)\r\n                    self.files[i].close()\r\n\r\n        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(self.empty) == self.num_buffers:\r\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">False</span>\r\n\r\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">True</span>\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">unshift</span>(<span class=\"hljs-params\">self, index</span>):\r\n        value = self.buffers[index]\r\n        self.buffers[index] = <span class=\"hljs-literal\">None</span>\r\n\r\n        <span class=\"hljs-keyword\">return</span> value\r\n\r\n\r\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FileMerger</span>:\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, merge_strategy</span>):\r\n        self.merge_strategy = merge_strategy\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">merge</span>(<span class=\"hljs-params\">self, filenames, outfilename, buffer_size</span>):\r\n        buffers = FilesArray(self.get_file_handles(filenames, buffer_size))\r\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(outfilename, <span class=\"hljs-string\">&quot;w&quot;</span>, buffer_size) <span class=\"hljs-keyword\">as</span> outfile:\r\n            <span class=\"hljs-keyword\">while</span> buffers.refresh():\r\n                min_index = self.merge_strategy.select(buffers.get_dict())\r\n                outfile.write(buffers.unshift(min_index))\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_file_handles</span>(<span class=\"hljs-params\">self, filenames, buffer_size</span>):\r\n        files = {}\r\n\r\n        <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(filenames)):\r\n            files[i] = <span class=\"hljs-built_in\">open</span>(filenames[i], <span class=\"hljs-string\">&quot;r&quot;</span>, buffer_size)\r\n\r\n        <span class=\"hljs-keyword\">return</span> files\r\n\r\n\r\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">ExternalSort</span>:\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, block_size</span>):\r\n        self.block_size = block_size\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">sort</span>(<span class=\"hljs-params\">self, filename, sort_key=<span class=\"hljs-literal\">None</span></span>):\r\n        num_blocks = self.get_number_blocks(filename, self.block_size)\r\n        splitter = FileSplitter(filename)\r\n        splitter.split(self.block_size, sort_key)\r\n\r\n        merger = FileMerger(NWayMerge())\r\n        buffer_size = self.block_size / (num_blocks + <span class=\"hljs-number\">1</span>)\r\n        merger.merge(splitter.get_block_filenames(), filename + <span class=\"hljs-string\">&quot;.out&quot;</span>, buffer_size)\r\n\r\n        splitter.cleanup()\r\n\r\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_number_blocks</span>(<span class=\"hljs-params\">self, filename, block_size</span>):\r\n        <span class=\"hljs-keyword\">return</span> (os.stat(filename).st_size / block_size) + <span class=\"hljs-number\">1</span>\r\n\r\n\r\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">parse_memory</span>(<span class=\"hljs-params\">string</span>):\r\n    <span class=\"hljs-keyword\">if</span> string[-<span class=\"hljs-number\">1</span>].lower() == <span class=\"hljs-string\">&quot;k&quot;</span>:\r\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">int</span>(string[:-<span class=\"hljs-number\">1</span>]) * <span class=\"hljs-number\">1024</span>\r\n    <span class=\"hljs-keyword\">elif</span> string[-<span class=\"hljs-number\">1</span>].lower() == <span class=\"hljs-string\">&quot;m&quot;</span>:\r\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">int</span>(string[:-<span class=\"hljs-number\">1</span>]) * <span class=\"hljs-number\">1024</span> * <span class=\"hljs-number\">1024</span>\r\n    <span class=\"hljs-keyword\">elif</span> string[-<span class=\"hljs-number\">1</span>].lower() == <span class=\"hljs-string\">&quot;g&quot;</span>:\r\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">int</span>(string[:-<span class=\"hljs-number\">1</span>]) * <span class=\"hljs-number\">1024</span> * <span class=\"hljs-number\">1024</span> * <span class=\"hljs-number\">1024</span>\r\n    <span class=\"hljs-keyword\">else</span>:\r\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">int</span>(string)\r\n\r\n\r\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">main</span>():\r\n    parser = argparse.ArgumentParser()\r\n    parser.add_argument(\r\n        <span class=\"hljs-string\">&quot;-m&quot;</span>, <span class=\"hljs-string\">&quot;--mem&quot;</span>, <span class=\"hljs-built_in\">help</span>=<span class=\"hljs-string\">&quot;amount of memory to use for sorting&quot;</span>, default=<span class=\"hljs-string\">&quot;100M&quot;</span>\r\n    )\r\n    parser.add_argument(\r\n        <span class=\"hljs-string\">&quot;filename&quot;</span>, metavar=<span class=\"hljs-string\">&quot;&lt;filename&gt;&quot;</span>, nargs=<span class=\"hljs-number\">1</span>, <span class=\"hljs-built_in\">help</span>=<span class=\"hljs-string\">&quot;name of file to sort&quot;</span>\r\n    )\r\n    args = parser.parse_args()\r\n\r\n    sorter = ExternalSort(parse_memory(args.mem))\r\n    sorter.sort(args.filename[<span class=\"hljs-number\">0</span>])\r\n\r\n\r\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&quot;__main__&quot;</span>:\r\n    main()\r\n"
    }
  },
  "contributors": [
    {
      "name": "ParthS007",
      "email": "parth1989shandilya@gmail.com",
      "commits": 1
    },
    {
      "name": "William Zhang",
      "email": "39932068+WilliamHYZhang@users.noreply.github.com",
      "commits": 1
    },
    {
      "name": "Mickaël Schoentgen",
      "email": "contact@tiger-222.fr",
      "commits": 1
    },
    {
      "name": "cclauss",
      "email": "cclauss@bluewin.ch",
      "commits": 1
    },
    {
      "name": "Shivam sharma",
      "email": "shivams334@gmail.com",
      "commits": 1
    },
    {
      "name": "Christian Clauss",
      "email": "cclauss@me.com",
      "commits": 2
    }
  ],
  "explanationUrl": {}
}